{% set dice_config = {
    'd4': {'color': 'yellow', 'label': 'D4'},
    'd6': {'color': 'blue', 'label': 'D6'},
    'd12': {'color': 'purple', 'label': 'D12'},
    'd20': {'color': 'red', 'label': 'D20'}
} %}

<div class="bg-zinc-900 border border-zinc-800 p-0 relative group overflow-hidden shadow-2xl flex flex-col h-full rounded-sm" id="card-{{player.id}}">
    <div class="absolute top-0 right-0 w-32 h-32 bg-red-600/5 blur-[60px] -z-10 group-hover:bg-red-600/10 transition-all"></div>
    <div class="h-1 w-full bg-gradient-to-r from-red-600 to-transparent"></div>

    <div class="p-4 md:p-5 flex-1">
        <div class="flex justify-between items-start mb-4">
            <div class="w-full pr-2">
                <h2 class="text-2xl font-black uppercase text-white tracking-tighter whitespace-normal break-words leading-none mb-2">{{ player.name }}</h2>
                
                <div class="flex gap-2 items-center text-[11px] font-mono text-zinc-500 uppercase tracking-wider flex-wrap">
                    <span class="bg-zinc-950 border border-zinc-800 px-2 py-1 font-bold">{{ player.age }} ANOS</span>
                    
                    <div class="flex items-center bg-zinc-950 border border-red-900/30 group/lvl hover:border-red-600 transition-colors">
                        <button hx-post="{{ url_for('update_level', pid=player.id, action='dec') }}" hx-target="#card-{{player.id}}" hx-swap="outerHTML" 
                                class="px-3 py-1 hover:bg-red-600 hover:text-white transition text-red-700 font-bold touch-manipulation">-</button>
                        
                        <span class="text-red-500 font-black px-1 text-xs">NV {{ player.level }}</span>
                        
                        <button hx-post="{{ url_for('update_level', pid=player.id, action='inc') }}" hx-target="#card-{{player.id}}" hx-swap="outerHTML" 
                                class="px-3 py-1 hover:bg-red-600 hover:text-white transition text-red-700 font-bold touch-manipulation">+</button>
                    </div>
                </div>
            </div>
            <button hx-delete="{{ url_for('delete_player', pid=player.id) }}" hx-target="#card-{{player.id}}" hx-swap="outerHTML" 
                    class="text-zinc-700 hover:text-red-600 transition-colors p-2 -mt-2 -mr-2 flex-shrink-0">
                <i data-lucide="trash-2" width="20"></i>
            </button>
        </div>

        <div class="grid grid-cols-4 gap-2 mb-6 bg-zinc-950/50 p-2 border border-zinc-800/50 rounded-sm">
            {% for die, config in dice_config.items() %}
                {% set result = player.dice.get(die) %}
                {% set active_color = config.color %}
                
                <button hx-post="{{ url_for('roll_die', pid=player.id, die=die) }}" hx-target="#card-{{player.id}}" hx-swap="outerHTML"
                    class="relative h-12 md:h-14 flex flex-col items-center justify-center border transition-all overflow-hidden group/die active:scale-95 touch-manipulation
                    {{ 'shadow-[0_0_10px_rgba(0,0,0,0.3)]' if result else 'opacity-80 hover:opacity-100' }}"
                    style="border-color: var(--tw-color-{{active_color}}-900); background-color: rgba(var(--tw-color-{{active_color}}-950), 0.3);">
                    
                    <span class="text-[9px] font-black uppercase absolute top-1 left-1 opacity-50" 
                          style="color: var(--tw-color-{{active_color}}-500);">{{config.label}}</span>
                    
                    {% if result %}
                        <span class="text-2xl font-black tracking-tighter animate-in zoom-in duration-300 drop-shadow-md"
                              style="color: var(--tw-color-{{active_color}}-400);">{{result}}</span>
                    {% else %}
                        <i data-lucide="dices" width="18" class="transition-opacity opacity-40 group-hover/die:opacity-100"
                           style="color: var(--tw-color-{{active_color}}-600);"></i>
                    {% endif %}
                </button>
            {% endfor %}
        </div>

        <div class="grid grid-cols-1 gap-5 mb-6">
            {% for stat_info in [
                {'label': 'VIGOR', 'key': 'current_pv', 'max': 'pv_max', 'color': 'red'},
                {'label': 'SANIDADE', 'key': 'current_ps', 'max': 'ps_max', 'color': 'blue'},
                {'label': 'AURA', 'key': 'current_pa', 'max': 5, 'color': 'yellow', 'is_pa': true}
            ] %}
            <div class="relative group/bar">
                <div class="flex justify-between text-[10px] font-black text-{{stat_info.color}}-600 uppercase mb-1 z-10 relative tracking-wider">
                    <span>{{stat_info.label}}</span> 
                    <span class="text-xs">{{ player[stat_info.key] }} / {{ 5 if stat_info.is_pa else player.stats[stat_info.max] }}</span>
                </div>
                <div class="flex items-center gap-1 bg-zinc-950 border border-zinc-800 p-1 rounded-sm h-8">
                    <button hx-post="{{ url_for('update_stat', pid=player.id, stat=stat_info.key, action='dec') }}" hx-target="#card-{{player.id}}" hx-swap="outerHTML" 
                            class="h-full px-3 hover:bg-zinc-800 text-zinc-500 hover:text-white transition bg-zinc-900/50 touch-manipulation active:bg-zinc-800 flex items-center">-</button>
                    
                    <div class="flex-1 h-3 bg-zinc-900 overflow-hidden relative rounded-sm">
                        {% if stat_info.is_pa %}
                             <div class="flex gap-0.5 h-full w-full absolute inset-0">
                                {% for i in range(1, 6) %}
                                <div class="flex-1 {{ 'bg-yellow-500' if i <= player.current_pa else 'bg-zinc-800' }}"></div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="h-full bg-{{stat_info.color}}-600 transition-all" 
                                 style="width: {{ (player[stat_info.key] / player.stats[stat_info.max] * 100)|round }}%"></div>
                        {% endif %}
                    </div>
                    
                    <button hx-post="{{ url_for('update_stat', pid=player.id, stat=stat_info.key, action='inc') }}" hx-target="#card-{{player.id}}" hx-swap="outerHTML" 
                            class="h-full px-3 hover:bg-zinc-800 text-zinc-500 hover:text-white transition bg-zinc-900/50 touch-manipulation active:bg-zinc-800 flex items-center">+</button>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="grid grid-cols-5 gap-1 pt-4 border-t border-zinc-800 mb-4">
            {% for k, v in player.stats.final_attrs.items() %}
            <div class="bg-zinc-950 border border-zinc-800 py-2 text-center group hover:border-red-900/50 transition-colors">
                <div class="text-[9px] uppercase text-zinc-500 font-bold tracking-wider mb-0.5">{{k}}</div>
                <div class="text-2xl font-black {{ 'text-red-500' if v > 3 else 'text-zinc-200' }} leading-none">{{v}}</div>
            </div>
            {% endfor %}
        </div>

        <div class="flex flex-wrap gap-1 mb-6">
            {% for sid in player.specs %}
                <span class="text-[9px] font-bold uppercase bg-zinc-800 text-zinc-400 border border-zinc-700 px-2 py-1 tracking-wider">
                    {{ specs[sid].name }}
                </span>
            {% endfor %}
        </div>

        <div class="border-t border-zinc-800 pt-4">
            <h3 class="text-[11px] font-black text-zinc-500 uppercase mb-3 flex items-center gap-1">
                <i data-lucide="package" width="14"></i> Invent√°rio
            </h3>
            
            <div class="space-y-1 mb-3">
                {% for item in player.inventory %}
                <div class="flex items-start justify-between bg-zinc-950 p-2 border border-zinc-800 group hover:border-zinc-700 transition">
                    
                    <div class="flex flex-col mr-2 mt-0.5">
                        <button hx-post="{{ url_for('reorder_item', pid=player.id, item_id=item.id, direction='up') }}" hx-target="#card-{{player.id}}" hx-swap="outerHTML"
                                class="text-zinc-600 hover:text-white disabled:opacity-20 p-1" {{ 'disabled' if loop.first }}>
                            <i data-lucide="chevron-up" width="14"></i>
                        </button>
                        <button hx-post="{{ url_for('reorder_item', pid=player.id, item_id=item.id, direction='down') }}" hx-target="#card-{{player.id}}" hx-swap="outerHTML"
                                class="text-zinc-600 hover:text-white disabled:opacity-20 p-1" {{ 'disabled' if loop.last }}>
                            <i data-lucide="chevron-down" width="14"></i>
                        </button>
                    </div>

                    <div class="flex-1 flex items-start gap-2 min-w-0 py-1">
                        <span class="text-xs font-mono text-zinc-500 select-none mt-0.5">{{ loop.index }}.</span>
                        <span class="text-xs uppercase font-bold text-zinc-300 whitespace-normal break-words leading-tight">{{ item.name }}</span>
                    </div>
                    
                    <div class="flex items-center gap-2 ml-2 mt-0.5">
                        <div class="flex items-center bg-zinc-900 border border-zinc-800">
                            <button hx-post="{{ url_for('update_item', pid=player.id, item_id=item.id, action='dec') }}" hx-target="#card-{{player.id}}" hx-swap="outerHTML" class="px-3 py-1 hover:text-red-500 text-zinc-500 text-sm touch-manipulation">-</button>
                            <span class="text-xs font-mono w-6 text-center">{{ item.qty }}</span>
                            <button hx-post="{{ url_for('update_item', pid=player.id, item_id=item.id, action='inc') }}" hx-target="#card-{{player.id}}" hx-swap="outerHTML" class="px-3 py-1 hover:text-green-500 text-zinc-500 text-sm touch-manipulation">+</button>
                        </div>
                        <button hx-delete="{{ url_for('delete_item', pid=player.id, item_id=item.id) }}" hx-target="#card-{{player.id}}" hx-swap="outerHTML" class="text-zinc-700 hover:text-red-600 pl-1 p-2">
                            <i data-lucide="x" width="16"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>

            <form hx-post="{{ url_for('add_item', pid=player.id) }}" hx-target="#card-{{player.id}}" hx-swap="outerHTML" class="flex gap-1">
                <input type="text" name="item_name" placeholder="ITEM..." required 
                       class="w-full bg-zinc-950 border border-zinc-800 text-xs px-3 py-3 md:py-2 text-white uppercase outline-none focus:border-red-900 placeholder:text-zinc-700 rounded-sm">
                <button type="submit" class="bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 text-zinc-300 px-4 md:px-3 transition rounded-sm">
                    <i data-lucide="plus" width="16"></i>
                </button>
            </form>
        </div>
    </div>
</div>
